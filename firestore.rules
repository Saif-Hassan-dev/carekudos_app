rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function: Check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Helper function: Check if user owns the document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Users collection
    match /users/{userId} {
      // Anyone authenticated can read any user profile
      allow read: if isSignedIn();
      
      // Only the user can create their own profile
      allow create: if isSignedIn() && isOwner(userId);
      
      // Owner can update anything; others can only increment star fields
      allow update: if isSignedIn() 
                    && (isOwner(userId)
                        || request.resource.data.diff(resource.data).affectedKeys()
                           .hasOnly(['totalStars', 'starsThisMonth']));
      
      // Users cannot delete their profile
      allow delete: if false;
    }
    
    // Posts collection
    match /posts/{postId} {
      // Anyone authenticated can read posts
      allow read: if isSignedIn();
      
      // Only authenticated users can create posts
      // Must include authorId matching their user ID
      allow create: if isSignedIn() 
                    && request.resource.data.authorId == request.auth.uid;
      
      // Author can update anything; others can only update stars/starredBy
      allow update: if isSignedIn() 
                    && (resource.data.authorId == request.auth.uid
                        || request.resource.data.diff(resource.data).affectedKeys()
                           .hasOnly(['stars', 'starredBy']));
      
      // Only post author can delete their posts
      allow delete: if isSignedIn() 
                    && resource.data.authorId == request.auth.uid;
      
      // Subcollection: Stars given to posts
      match /starredBy/{userId} {
        // Anyone can read who starred a post
        allow read: if isSignedIn();
        
        // Only the user can star a post (create star document)
        allow create: if isSignedIn() && userId == request.auth.uid;
        
        // Users can remove their own stars
        allow delete: if isSignedIn() && userId == request.auth.uid;
      }
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      // Users can only read their own notifications
      allow read: if isSignedIn() 
                  && resource.data.userId == request.auth.uid;
      
      // System can create notifications for users
      allow create: if isSignedIn();
      
      // Users can update their own notifications (e.g., mark as read)
      allow update: if isSignedIn() 
                    && resource.data.userId == request.auth.uid;
      
      // Users can delete their own notifications
      allow delete: if isSignedIn() 
                    && resource.data.userId == request.auth.uid;
    }
    
    // Comments collection (future use)
    match /comments/{commentId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() 
                    && resource.data.authorId == request.auth.uid;
      allow delete: if isSignedIn() 
                    && resource.data.authorId == request.auth.uid;
    }
    
    // Achievements collection (future use)
    match /achievements/{achievementId} {
      allow read: if isSignedIn();
      allow write: if false; // Only admin/system can write
    }
    
    // Star history collection â€“ tracks every star given
    match /star_history/{historyId} {
      // Any authenticated user can read star history
      // (queries are filtered by giverId or receiverId in app code)
      allow read: if isSignedIn();
      
      // Only authenticated users can create star history entries
      // Cannot give stars to yourself
      allow create: if isSignedIn()
                    && request.resource.data.giverId == request.auth.uid
                    && request.resource.data.giverId != request.resource.data.receiverId;
      
      // Star history should not be edited or deleted
      allow update, delete: if false;
    }
    
    // Push notifications queue (processed by Cloud Functions)
    match /push_notifications/{notifId} {
      // Only the recipient can read their push notifications
      allow read: if isSignedIn()
                  && resource.data.recipientId == request.auth.uid;
      
      // Any authenticated user can create (queue) a push notification
      allow create: if isSignedIn();
      
      // No edits or deletes from clients
      allow update, delete: if false;
    }
    
    // Organizations collection (for future use)
    match /organizations/{orgId} {
      allow read: if isSignedIn();
      allow write: if false; // Only admins via backend
    }
  }
}
